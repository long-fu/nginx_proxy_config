# ä½¿ç”¨ä»£ç†è¿›è¡Œæ‹‰æµæ–¹æ¡ˆ

RTMP â€”â€” æ¨æ¨¡å‹

```
FFmpeg â”€â”€æ¨â”€â”€> RTMP æºç«™
```

æ¨æµç«¯ä¸»åŠ¨å‘é€

æœåŠ¡ç«¯è¢«åŠ¨æ¥æ”¶

ä¸€æ¡æµ = ä¸€æ¡ TCP è¿æ¥

HTTP-FLV â€”â€” æ‹‰æ¨¡å‹ï¼ˆHTTPï¼‰

```
æµè§ˆå™¨ â”€â”€æ‹‰â”€â”€> ä»£ç† â”€â”€æ‹‰â”€â”€> æºç«™
```



HTTP GET è¯·æ±‚

è°è¯·æ±‚ï¼Œè°æ‰å»ºç«‹è¿æ¥

é•¿è¿æ¥æŒç»­è¯»æ•°æ®

ğŸ‘‰ HTTP-FLV å¤©ç”Ÿæ˜¯â€œå®¢æˆ·ç«¯æ‹‰â€

å®é™…ä¸Šå‘ç”Ÿçš„æ˜¯ğŸ‘‡

```sh
1ï¸âƒ£ æµè§ˆå™¨ â†’ ä»£ç†
   GET /live?app=live&stream=stream1

2ï¸âƒ£ ä»£ç† â†’ æºç«™
   GET /live?app=live&stream=stream1

3ï¸âƒ£ æºç«™ï¼š
   - å‘ç°æœ‰ stream1
   - å¼€ä¸€æ¡ HTTP-FLV è¾“å‡ºè¿æ¥
   - æŒç»­å†™ FLV æ•°æ®

4ï¸âƒ£ ä»£ç†ï¼š
   - è¾¹è¯»è¾¹è½¬å‘
   - ä¸ç¼“å­˜ã€ä¸å­˜ç›˜

5ï¸âƒ£ æµè§ˆå™¨ï¼š
   - flv.js è¾¹æ”¶è¾¹æ’­
```

ç½‘ç»œçœŸå®æ‹“æ‰‘
```
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ æºç«™ A (RTMP + HTTP-FLV)
               â”‚
æµè§ˆå™¨ â”€â”€> ä»£ç† â”œâ”€â”€â”€â”€â”€â”€â”€â”€ æºç«™ B (RTMP + HTTP-FLV)
               â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€ æºç«™ C (RTMP + HTTP-FLV)
```

```

FFmpeg
  â”œâ”€â”€ RTMP â†’ æºç«™ A
  â”œâ”€â”€ RTMP â†’ æºç«™ B
  â””â”€â”€ RTMP â†’ æºç«™ C

æµè§ˆå™¨
  â””â”€â”€ HTTP-FLV â†’ ä»£ç†æœåŠ¡å™¨
                       â”œâ”€â”€ æ‹‰ æºç«™ A
                       â”œâ”€â”€ æ‹‰ æºç«™ B
                       â””â”€â”€ æ‹‰ æºç«™ C
```

[æºç«™é…ç½®](./src_nginx.conf)
[ä»£ç†é…ç½®](./proxy_nginx.conf)


# æµ‹è¯•

```sh
# æ¨æµåˆ°æºç«™æµæœåŠ¡å™¨ä¸Š
ffmpeg -stream_loop -1 -re -i live.mp4 \
  -c:v libx264 -c:a aac \
  -f flv \
  rtmp://192.168.8.208:1935/myapp/test

# æ‹‰ä»£ç†æœåŠ¡å™¨çš„æµ
ffplay http://192.168.8.14:18090/live?src=a&port=1935&app=myapp&stream=test
```

# æ–¹æ¡ˆäºŒ

æºç«™çš„çš„RTMP äºŒæ¬¡æ¨é€åˆ°ä»£ç†(RTMP + HTTP-FLV) æµè§ˆå™¨æŸ¥çœ‹ ä»£ç†æœåŠ¡å™¨çš„æ•°æ®

ç½‘ç»œæ‹“æ‰‘
```txt
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ æºç«™ A   â”‚
æ¨æµ ---> â”‚ RTMP     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 \
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
æ¨æµ ---> â”‚ æºç«™ B   â”‚
          â”‚ RTMP     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 \
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
æ¨æµ ---> â”‚ æºç«™ C   â”‚
          â”‚ RTMP     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 |
                 | RTMP pullï¼ˆæŒ‰éœ€ / å•è·¯ï¼‰
                 v
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ä»£ç†æœåŠ¡å™¨ nginx â”‚
        â”‚ rtmp + http-flv  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   |
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚            â”‚            â”‚
   Webå®¢æˆ·ç«¯1    Webå®¢æˆ·ç«¯2    Webå®¢æˆ·ç«¯3
   HTTP-FLV      HTTP-FLV      HTTP-FLV

```


```txt


æºç«™ A(RTMP) -> ä»£ç†(RTMP + HTTP-FLV) <- æµè§ˆå™¨ 

æºç«™ B(RTMP) ->
```

æºç«™é…ç½®
```conf
rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        application myapp {
            live on;
            record off;

            # ğŸ”¥ äºŒæ¬¡æ¨é€åˆ°ä»£ç†
            push rtmp://proxy_ip/myapp;
        }
    }
}
```
ä»£ç†é…ç½®
```conf
rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        application live {
            live on;
            record off;
        }
    }
}

http {
    server {
        listen 8080;

        location /myapp {
            flv_live on;
            add_header Cache-Control no-cache;
        }
    }
}
```

